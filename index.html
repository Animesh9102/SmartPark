import React, { useState, useEffect, createContext, useContext } from 'react';

// --- Utility Functions ---
const generateId = () => Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

// --- Language Context ---
const LanguageContext = createContext();

const translations = {
    en: {
        appName: "SmartPark",
        settings: "Settings",
        logout: "Logout",
        registerForSmartPark: "New User!! Register here....", // Updated text
        fullName: "Full Name",
        mobileNumber: "Mobile Number",
        email: "Email",
        password: "Password",
        register: "Register",
        registrationSuccessful: "Registration Successful!",
        welcomeToSmartPark: "Welcome to SmartPark! You can now search for parking spots.",
        registrationFailed: "Registration Failed",
        pleaseFillAllFields: "Please fill in all fields.",
        findYourParkingSpot: "Find Your Parking Spot",
        selectCity: "Select City",
        enterLocation: "Enter location or destination",
        search: "Search",
        poweredByAI: "Powered by Predictive Availability AI for optimal suggestions.",
        realTimeMapView: "Real-Time Map View",
        available: "Available",
        premium: "Premium",
        occupied: "Occupied",
        searchResults: "Search Results",
        searchingForParking: (loc) => `Searching for parking near "${loc}". Showing real-time availability.`,
        searchError: "Search Error",
        pleaseEnterLocation: "Please enter a location to search.",
        selectYourSlot: "Select Your Slot",
        pricesDynamicallyAdjusted: "Prices are dynamically adjusted based on demand.",
        slotSelected: "Slot Selected",
        youHaveSelected: (slotName, price) => `You have selected ${slotName}. Price: ₹${price}.`,
        selectionRequired: "Selection Required",
        pleaseSelectSlot: "Please select a parking slot first.",
        carWashAddon: "1-Tap Car Wash Add-on (₹150)",
        proceedToBooking: "Proceed to Booking",
        bookingSummary: "Booking Summary",
        noBookingDetails: "No booking details available. Please go back and select a slot.",
        parkingSlot: "Parking Slot",
        basePrice: "Base Price",
        carWash: "1-Tap Car Wash",
        localParkingTax: (rate) => `Local Parking Tax (${rate}%):`,
        totalAmount: "Total Amount:",
        confirmBooking: "Confirm Booking & Pay",
        bookingConfirmed: "Booking Confirmed",
        proceedingToPayment: "Your booking is confirmed! Proceeding to payment.",
        completePayment: "Complete Payment",
        amountDue: "Amount Due:",
        payWithUPI: "Pay with UPI",
        corporateBilling: "Corporate Billing",
        paymentProcessedSecurely: "Your payment is processed securely with tokenization for PCI-DSS compliance.",
        processingPayment: "Processing Payment",
        simulatingUpiPayment: "Simulating UPI payment... Payment tokenized for PCI-DSS compliance.",
        paymentSuccessful: "Payment Successful!",
        paidViaUPI: (amount) => `₹${amount} paid via UPI. Your QR check-in code is ready.`,
        requestSentToCorporate: "Request sent to your corporate account for approval. Payment will be processed automatically.",
        invoiceDetails: "Invoice Details",
        noInvoiceAvailable: "No invoice available. Please complete a booking first.",
        invoiceID: "Invoice ID:",
        date: "Date:",
        service: "Service:",
        addOn: "Add-on:",
        taxableAmount: "Taxable Amount:",
        gst: (rate) => `GST (${rate}%):`,
        totalAmountDue: "Total Amount Due:",
        qrCheckinCode: "QR Check-in Code",
        scanCodeForEntry: "Scan this code at the parking gate for seamless entry and auto-checkout.",
        startNewBooking: "Start New Booking",
        thankYou: "Thank You!",
        parkingExperienceComplete: "Your parking experience is now complete. We look forward to serving you again!",
        appSettings: "App Settings",
        languageRegion: "Language & Region",
        currentLanguage: (lang) => `Current language: ${lang}`,
        familySharing: "Family Sharing",
        shareSubscription: "Share your SmartPark subscription benefits with your family members.",
        manageFamily: "Manage Family",
        familySharingInitiated: "Family sharing setup initiated. Invite members via email.",
        emergencyServices: "Emergency Services",
        requestAssistance: "Request emergency assistance directly from the app.",
        requestJumpStart: "Request Jump-Start",
        jumpStartRequested: "Emergency jump-start service requested. Our team is on the way!",
        dataPrivacy: "Data & Privacy (GDPR)",
        deleteMyAccount: "Delete My Account",
        exerciseRightToDelete: "Exercise your right to data deletion.",
        confirmDeletion: "Confirm Deletion",
        areYouSureDeleteAccount: "Are you sure you want to delete your account? This action is irreversible.",
        gdprDataRemoval: "In accordance with GDPR, all your personal data will be permanently removed.",
        accountDeleted: "Account Deleted",
        accountDeletedMessage: "Your account and all associated data have been permanently deleted as per GDPR compliance.",
        suggestedParkingLocations: "Suggested Parking Locations",
        bestParkingFor: (loc) => `Best Parking for "${loc}"`,
        regularUsedLocations: "Regularly Used Locations",
        location: "Location",
        distance: "Distance",
        availability: "Availability",
        services: "Services",
        carWashDetailing: "Car Wash & Detailing",
        getCarSparkling: "Get your car sparkling while parked.",
        evCharging: "EV Charging",
        findBookCharging: "Find and book charging stations.",
        vehicleMaintenance: "Vehicle Maintenance",
        minorServicing: "Minor servicing at your parking spot.",
        valetParking: "Valet Parking",
        hassleFreeParking: "Hassle-free parking and retrieval.",
        priorityBooking: "Priority Booking for Premium Users",
        premiumBenefits: "Enjoy guaranteed spots and exclusive access with a premium subscription.",
        dynamicPricing: "Dynamic Pricing Explained",
        pricingAdjusts: "Our prices adjust in real-time based on demand, ensuring fair rates.",
        corporateBillingBenefits: "Corporate Billing Benefits",
        streamlineExpenses: "Streamline parking expenses for your business with centralized billing.",
        evChargingLocator: "EV Charging Locator",
        findChargingStations: "Find nearby EV charging stations on the map.",
        locateCharging: "Locate Charging Stations",
        valetParkingService: "Valet Parking Service",
        bookValet: "Book a valet to park your car for ultimate convenience.",
        bookValetService: "Book Valet Service",
        carWashService: "Car Wash Service",
        scheduleCarWash: "Schedule a car wash and detailing while your car is parked.",
        scheduleService: "Schedule Service",
        nearbyAvailableSpots: "Nearby Available Spots",
        spotBookedSuccessfully: (spot) => `Spot at ${spot} booked successfully!`,
        automatedParkingBooked: "Automated parking spot booked successfully!",
        prebookAdvanced: "Advanced Pre-Booking",
        timeFrom: "Time From",
        timeTo: "Time To",
        confirmPrebook: "Confirm Pre-book",
        prebookSubmitted: "Your pre-booking request has been submitted. We'll notify you when a spot is confirmed!",
        myBookings: "My Bookings",
        status: "Status:",
        confirmed: "Confirmed",
        completed: "Completed",
        repeatBooking: "Repeat Booking",
        login: "Login",
        userLogin: "User Login",
        providerLogin: "Service Provider Login",
        username: "Username",
        loginFailed: "Login Failed",
        invalidCredentials: "Invalid credentials. Please try again.",
        welcomeProvider: "Welcome, Service Provider!",
        dashboard: "Dashboard",
        currentOccupancy: "Current Occupancy",
        parkingSpots: "Parking Spots",
        occupiedSpots: "Occupied Spots",
        availableSpots: "Available Spots",
        manageSpots: "Manage Spots",
        addSpot: "Add Spot",
        spotId: "Spot ID",
        spotType: "Spot Type",
        standard: "Standard",
        premiumSpot: "Premium Spot",
        evChargingSpot: "EV Charging Spot",
        valetSpot: "Valet Spot",
        add: "Add",
        remove: "Remove",
        spotAdded: (id) => `Spot ${id} added!`,
        spotRemoved: (id) => `Spot ${id} removed!`,
        spotAlreadyExists: (id) => `Spot ${id} already exists.`,
        spotNotFound: (id) => `Spot ${id} not found.`,
        bookingHistory: "Booking History",
        noBookingsYet: "No bookings yet.",
        manageServiceRequests: "Manage Service Requests",
        noServiceRequests: "No service requests.",
        requestType: "Request Type",
        customer: "Customer",
        complete: "Complete",
        requestCompleted: "Request completed!",
        selectUserType: "Select User Type",
        customerApp: "Customer App",
        serviceProviderApp: "Service Provider App",
        copyright: "© 2025 SmartPark. All rights reserved.",
        enhancedWithAI: "Enhanced with AI, compliant with global standards, and designed for your convenience.",
        forgotPassword: "Forgot Password?",
        resetPassword: "Reset Password",
        enterEmailForReset: "Enter your email to receive a password reset link.",
        sendResetLink: "Send Reset Link",
        resetLinkSent: "If an account with that email exists, a password reset link has been sent.",
        backToLogin: "Back to Login",
        providerRegistration: "Provider Registration",
        registerAsProvider: "Register as a Service Provider",
        backToUserTypeSelection: "Back to User Type Selection",
        currentLocation: "Current Location",
        close: "Close",
        aboutUs: "About Us",
        aboutUsContent: "SmartPark is dedicated to revolutionizing urban mobility by providing smart, efficient, and user-friendly parking solutions. Our mission is to reduce traffic congestion, minimize parking search times, and enhance the overall urban experience through innovative technology and strategic partnerships.\n\nOur Team:\n- Nilabja Sen\n- Animesh\n- Armaan Sanket\n- Sukhbir Sohal\n- Rahul",
        disclaimer: "Disclaimer: This application is a prototype for demonstration purposes. All data, prices, and services are simulated. Real-world functionality may vary.",
        emailSent: "Registration email sent to ",
        carModel: "Car Model",
        carCompany: "Car Company",
        maintenanceType: "Maintenance Type",
        selectMaintenance: "Select Maintenance Type",
        oilChange: "Oil Change",
        tireRotation: "Tire Rotation",
        brakeInspection: "Brake Inspection",
        fullService: "Full Service",
        other: "Other",
        scheduleBooking: "Schedule Booking",
        bookingScheduled: "Booking Scheduled!",
        pickUpLocation: "Pick-up Location",
        dropOffLocation: "Drop-off Location",
        valetBooking: "Valet Booking",
        valetBooked: "Valet service booked!",
        gpsRequired: "GPS Location Required",
        enableGpsMessage: "Please enable GPS location for this service to work.",
        enableGps: "Enable GPS",
        gpsEnabled: "GPS Enabled!",
        comingSoon: "जल्द आ रहा है!",
        comingSoonMessage: "हे!! हम जल्द ही आपके शहर में भी आ रहे हैं... हैप्पी बुकिंग।",
        lastBooked: "अंतिम बुक किया गया",
        peakHours: "पीक आवर्स",
        fillingFast: "तेजी से भर रहा है",
        spotsAvailable: (num) => `${num} स्पॉट उपलब्ध`,
        moreDetails: "अधिक विवरण",
        loginSuccessful: "लॉगिन सफल!"
    }
};

// --- Reusable Modal Component ---
const Modal = ({ show, title, message, onClose, children }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    if (!show) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div className="bg-blue-900 p-6 rounded-2xl shadow-xl text-center max-w-lg w-full space-y-4 border border-blue-700">
                {title && <h3 className="text-2xl font-bold text-amber-400 mb-2">{title}</h3>}
                {message && <p className="text-white text-lg">{message}</p>}
                {children}
                <button 
                    onClick={onClose} 
                    className="mt-4 bg-amber-400 text-blue-900 font-bold py-2 px-5 rounded-xl hover:bg-amber-500 transition duration-300"
                >
                    {t.close}
                </button>
            </div>
        </div>
    );
};

// --- Header Component ---
const Header = ({ onNavigate, onLogout, showLogout = true }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    return (
        <header className="bg-blue-800 p-4 shadow-lg flex items-center justify-between sticky top-0 z-20">
            <div className="flex items-center space-x-2">
                <span className="text-amber-400 text-4xl font-black relative">
                    P
                    <span className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xl font-bold">
                        &#x27A4;
                    </span>
                </span>
                <h1 className="text-3xl font-extrabold text-white">{t.appName}</h1>
            </div>
            <nav className="flex items-center space-x-4">
                <button onClick={() => onNavigate('settings')} className="text-blue-200 hover:text-white text-lg font-semibold">⚙️ {t.settings}</button>
                {showLogout && (
                    <button onClick={onLogout} className="bg-red-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-red-700 transition duration-300">
                        {t.logout}
                    </button>
                )}
            </nav>
        </header>
    );
};

// --- Footer Component ---
const Footer = () => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    return (
        <footer className="text-center py-8 mt-16 border-t border-blue-200 bg-blue-800 text-blue-200">
            <p>{t.copyright}</p>
            <p className="text-sm mt-2">{t.enhancedWithAI}</p>
        </footer>
    );
};

// --- Forgot Password Screen ---
const ForgotPasswordScreen = ({ onBackToLogin, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [email, setEmail] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        showModal(t.resetPassword, t.resetLinkSent);
        setEmail('');
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-[calc(100vh-160px)] p-4 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-8 shadow-xl max-w-md w-full border border-blue-200">
                <h2 className="text-3xl font-bold text-amber-600 mb-6 text-center">{t.forgotPassword}</h2>
                <p className="text-blue-800 mb-4 text-center">{t.enterEmailForReset}</p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="reset-email" className="block text-blue-800 text-sm font-bold mb-2">{t.email}</label>
                        <input 
                            type="email" 
                            id="reset-email" 
                            value={email} 
                            onChange={(e) => setEmail(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="your.email@example.com"
                            aria-label={t.email}
                        />
                    </div>
                    <button 
                        type="submit" 
                        className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg"
                        aria-label={t.sendResetLink}
                    >
                        {t.sendResetLink}
                    </button>
                </form>
                <button 
                    onClick={onBackToLogin} 
                    className="mt-6 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.backToLogin}
                >
                    {t.backToLogin}
                </button>
            </div>
        </div>
    );
};

// --- Customer App Screens ---

// Customer Login Screen
const CustomerLoginScreen = ({ onLoginSuccess, onRegisterClick, onForgotPasswordClick, onBackToUserTypeSelection, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        // Simple mock authentication
        if (email === 'user@example.com' && password === 'password') {
            showModal(t.loginSuccessful, t.welcomeToSmartPark);
            onLoginSuccess();
        } else {
            showModal(t.loginFailed, t.invalidCredentials);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-[calc(100vh-160px)] p-4 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-8 shadow-xl max-w-md w-full border border-blue-200">
                <h2 className="text-3xl font-bold text-amber-600 mb-6 text-center">{t.userLogin}</h2>
                <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                        <label htmlFor="customer-email" className="block text-blue-800 text-sm font-bold mb-2">{t.email}</label>
                        <input 
                            type="email" 
                            id="customer-email" 
                            value={email} 
                            onChange={(e) => setEmail(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="user@example.com"
                            aria-label={t.email}
                        />
                    </div>
                    <div>
                        <label htmlFor="customer-password" className="block text-blue-800 text-sm font-bold mb-2">{t.password}</label>
                        <input 
                            type="password" 
                            id="customer-password" 
                            value={password} 
                            onChange={(e) => setPassword(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="password"
                            aria-label={t.password}
                        />
                    </div>
                    <button 
                        type="submit" 
                        className="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg"
                        aria-label={t.login}
                    >
                        {t.login}
                    </button>
                </form>
                <button 
                    onClick={onForgotPasswordClick} 
                    className="mt-4 w-full text-blue-800 text-sm font-bold hover:underline"
                    aria-label={t.forgotPassword}
                >
                    {t.forgotPassword}
                </button>
                <button 
                    onClick={onRegisterClick} 
                    className="mt-2 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.registerForSmartPark}
                >
                    {t.registerForSmartPark}
                </button>
                <button 
                    onClick={onBackToUserTypeSelection} 
                    className="mt-4 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.backToUserTypeSelection}
                >
                    {t.backToUserTypeSelection}
                </button>
            </div>
        </div>
    );
};


// Registration Screen (for Customer)
const RegistrationScreen = ({ onRegisterSuccess, onLoginClick, onBackToUserTypeSelection, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [name, setName] = useState('');
    const [mobile, setMobile] = useState('');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleRegister = (e) => {
        e.preventDefault();
        if (name && mobile && email && password) {
            showModal(t.registrationSuccessful, t.welcomeToSmartPark);
            console.log(t.emailSent + email); // Simulate sending email
            onRegisterSuccess();
        } else {
            showModal(t.registrationFailed, t.pleaseFillAllFields);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-[calc(100vh-160px)] p-4 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-8 shadow-xl max-w-md w-full border border-blue-200">
                <h2 className="text-3xl font-bold text-amber-600 mb-6 text-center">{t.registerForSmartPark}</h2>
                <form onSubmit={handleRegister} className="space-y-4">
                    <div>
                        <label htmlFor="name" className="block text-blue-800 text-sm font-bold mb-2">{t.fullName}</label>
                        <input 
                            type="text" 
                            id="name" 
                            value={name} 
                            onChange={(e) => setName(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="John Doe"
                            aria-label={t.fullName}
                        />
                    </div>
                    <div>
                        <label htmlFor="mobile" className="block text-blue-800 text-sm font-bold mb-2">{t.mobileNumber}</label>
                        <input 
                            type="tel" 
                            id="mobile" 
                            value={mobile} 
                            onChange={(e) => setMobile(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="9876543210"
                            aria-label={t.mobileNumber}
                        />
                    </div>
                    <div>
                        <label htmlFor="email" className="block text-blue-800 text-sm font-bold mb-2">{t.email}</label>
                        <input 
                            type="email" 
                            id="email" 
                            value={email} 
                            onChange={(e) => setEmail(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="john.doe@example.com"
                            aria-label={t.email}
                        />
                    </div>
                    <div>
                        <label htmlFor="password" className="block text-blue-800 text-sm font-bold mb-2">{t.password}</label>
                        <input 
                            type="password" 
                            id="password" 
                            value={password} 
                            onChange={(e) => setPassword(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="********"
                            aria-label={t.password}
                        />
                    </div>
                    <button 
                        type="submit" 
                        className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg"
                        aria-label={t.register}
                    >
                        {t.register}
                    </button>
                </form>
                <button 
                    onClick={onLoginClick} 
                    className="mt-4 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.userLogin}
                >
                    {t.userLogin}
                </button>
                <button 
                    onClick={onBackToUserTypeSelection} 
                    className="mt-4 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.backToUserTypeSelection}
                >
                    {t.backToUserTypeSelection}
                </button>
            </div>
        </div>
    );
};


// Home Screen (Search & Map View)
const HomeScreen = ({ onSearchSuccess, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [location, setLocation] = useState('');
    const [city, setCity] = useState('Bhubaneswar');

    // Simulated map data for Bhubaneswar and Jamshedpur
    const mapData = {
        Bhubaneswar: {
            image: "https://placehold.co/800x400/ADD8E6/00008B?text=Bhubaneswar+Map",
            spots: [
                { id: 'BBSR-P1', type: 'parking', x: 20, y: 30, available: true, premium: false, occupancy: 50 },
                { id: 'BBSR-P2', type: 'parking', x: 45, y: 50, available: true, premium: true, occupancy: 80 },
                { id: 'BBSR-EV1', type: 'ev', x: 60, y: 20, available: true, occupancy: 30 },
                { id: 'BBSR-V1', type: 'valet', x: 75, y: 65, available: true, occupancy: 60 },
                { id: 'BBSR-P3', type: 'parking', x: 30, y: 70, available: false, occupancy: 100 },
            ]
        },
        Jamshedpur: {
            image: "https://placehold.co/800x400/ADD8E6/00008B?text=Jamshedpur+Map",
            spots: [
                { id: 'JSR-P1', type: 'parking', x: 15, y: 40, available: true, premium: false, occupancy: 40 },
                { id: 'JSR-P2', type: 'parking', x: 50, y: 25, available: true, premium: false, occupancy: 70 },
                { id: 'JSR-EV1', type: 'ev', x: 35, y: 60, available: true, occupancy: 20 },
                { id: 'JSR-V1', type: 'valet', x: 80, y: 45, available: true, occupancy: 50 },
                { id: 'JSR-P3', type: 'parking', x: 70, y: 10, available: false, occupancy: 90 },
            ]
        },
        Delhi: {
            image: "https://placehold.co/800x400/ADD8E6/00008B?text=Delhi+Map",
            spots: [] // No specific spots for coming soon city
        },
        Mumbai: {
            image: "https://placehold.co/800x400/ADD8E6/00008B?text=Mumbai+Map",
            spots: [] // No specific spots for coming soon city
        },
        Bangalore: { // Added missing Bangalore entry
            image: "https://placehold.co/800x400/ADD8E6/00008B?text=Bangalore+Map",
            spots: []
        }
    };

    const currentMap = mapData[city];

    const handleSearch = () => {
        if (location.trim()) {
            showModal(t.searchResults, t.searchingForParking(location));
            onSearchSuccess();
        } else {
            showModal(t.searchError, t.pleaseEnterLocation);
        }
    };

    const handleCityChange = (e) => {
        const selectedCity = e.target.value;
        setCity(selectedCity);
        if (!mapData[selectedCity] || mapData[selectedCity].spots.length === 0) { // Added check for mapData[selectedCity] existence
            showModal(t.comingSoon, t.comingSoonMessage);
        }
    };

    const suggestedLocations = [
        { name: "Market Building", distance: "1.2 km", availability: "High", type: "Last Booked" },
        { name: "Infocity Mall", distance: "3.5 km", availability: "Medium", type: "Peak Hours" },
        { name: "Railway Station", distance: "0.5 km", availability: "Low", type: "Filling Fast", spots: 5 },
        { name: "City Center", distance: "2.0 km", availability: "High", type: "Last Booked" },
        { name: "Tech Park", distance: "4.0 km", availability: "Medium", type: "Peak Hours" },
    ];

    const regularUsedLocations = [
        { name: "Office Complex A", lastUsed: "Yesterday", spots: "3" },
        { name: "City Hospital", lastUsed: "2 days ago", spots: "2" },
    ];

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.findYourParkingSpot}</h2>
                <div className="flex flex-col md:flex-row gap-4 mb-4">
                    <select
                        value={city}
                        onChange={handleCityChange}
                        className="p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        aria-label={t.selectCity}
                    >
                        <option value="Bhubaneswar">Bhubaneswar</option>
                        <option value="Jamshedpur">Jamshedpur</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Mumbai">Mumbai</option>
                        <option value="Bangalore">Bangalore</option>
                    </select>
                    <input 
                        type="text" 
                        placeholder={t.enterLocation} 
                        value={location} 
                        onChange={(e) => setLocation(e.target.value)} 
                        className="flex-grow p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        aria-label={t.enterLocation}
                    />
                    <button 
                        onClick={handleSearch} 
                        className="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-purple-700 transition duration-300 shadow-lg"
                        aria-label={t.search}
                    >
                        {t.search}
                    </button>
                </div>
                <p className="text-blue-700 text-sm mt-3">{t.poweredByAI}</p>
            </div>

            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-blue-900 mb-4">{t.realTimeMapView}</h2>
                <div className="relative w-full h-96 rounded-xl overflow-hidden shadow-inner border border-blue-300">
                    <img 
                        src={currentMap.image} 
                        alt={`${city} Map`} 
                        className="absolute inset-0 w-full h-full object-cover" 
                        onError={(e) => {e.target.onerror=null;e.target.src='https://placehold.co/800x400/ADD8E6/00008B?text=Map+Not+Available';}}
                    />
                    {currentMap.spots.map(spot => (
                        <div 
                            key={spot.id} 
                            className={`absolute w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white cursor-pointer border-2
                                ${spot.available 
                                    ? (spot.premium ? 'bg-amber-500 border-amber-700' : 'bg-green-500 border-green-700') 
                                    : 'bg-red-500 border-red-700 opacity-70'
                                }
                                ${spot.type === 'ev' ? 'bg-blue-600 border-blue-800' : ''}
                                ${spot.type === 'valet' ? 'bg-purple-600 border-purple-800' : ''}
                            `}
                            style={{ left: `${spot.x}%`, top: `${spot.y}%` }}
                            title={
                                `${spot.id} - ${spot.available ? t.available : t.occupied}` +
                                `${spot.premium ? ` (${t.premium})` : ''}` +
                                `${spot.type === 'ev' ? ' (EV Charging)' : ''}` +
                                `${spot.type === 'valet' ? ' (Valet Parking)' : ''}`
                            }
                            onClick={() => showModal('Spot Info', `Details for ${spot.id}: ${spot.available ? t.available : t.occupied}. Type: ${spot.type}. Occupancy: ${spot.occupancy}%.`)}
                            aria-label={`Map spot ${spot.id}`}
                        >
                            {spot.type === 'ev' ? '⚡' : spot.type === 'valet' ? '🅿️' : (spot.available ? 'P' : 'X')}
                        </div>
                    ))}
                </div>
                <div className="flex flex-wrap justify-center gap-4 mt-4 text-sm text-blue-700">
                    <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-green-500 mr-2"></span>{t.available}</span>
                    <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-amber-500 mr-2"></span>{t.premium}</span>
                    <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-red-500 mr-2"></span>{t.occupied}</span>
                    <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-blue-600 mr-2"></span>EV Charging</span>
                    <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-purple-600 mr-2"></span>Valet Parking</span>
                </div>
            </div>

            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-blue-900 mb-4">{t.suggestedParkingLocations}</h2>
                <h3 className="text-xl font-semibold text-amber-600 mb-3">{t.bestParkingFor(location || t.currentLocation)}</h3>
                <div className="space-y-3 mb-6">
                    {suggestedLocations.map((loc, index) => (
                        <div 
                            key={index} 
                            className="flex justify-between items-center bg-blue-100 p-3 rounded-xl shadow-md cursor-pointer hover:bg-blue-200 transition duration-300"
                            onClick={() => showModal(loc.name, `Details for ${loc.name}: Distance ${loc.distance}, Availability ${loc.availability}. Type: ${loc.type}. ${loc.spots ? t.spotsAvailable(loc.spots) : ''}`)}
                        >
                            <p className="font-bold text-blue-900">{loc.name}</p>
                            <div className="text-right">
                                <p className="text-sm text-blue-700">{loc.distance} - {loc.availability}</p>
                                <p className="text-xs text-blue-500">{loc.type} {loc.spots ? `(${loc.spots})` : ''}</p>
                            </div>
                        </div>
                    ))}
                </div>

                <h3 className="text-xl font-semibold text-amber-600 mb-3">{t.regularUsedLocations}</h3>
                <div className="space-y-3">
                    {regularUsedLocations.map((loc, index) => (
                        <div key={index} className="flex justify-between items-center bg-blue-100 p-3 rounded-xl shadow-md">
                            <p className="font-bold text-blue-900">{loc.name}</p>
                            <p className="text-sm text-blue-700">Last used: {loc.lastUsed}</p>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- Booking Screens for Services ---
const CarWashBookingScreen = ({ onBookingComplete, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [date, setDate] = useState('');
    const [time, setTime] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (date && time) {
            showModal(t.bookingScheduled, `Car Wash scheduled for ${date} at ${time}.`);
            onBookingComplete({ type: 'Car Wash', date, time, status: t.confirmed, amount: 150 });
        } else {
            showModal(t.selectionRequired, t.pleaseFillAllFields);
        }
    };

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.scheduleCarWash}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="wash-date" className="block text-blue-800 text-sm font-bold mb-2">{t.date}</label>
                        <input type="date" id="wash-date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    </div>
                    <div>
                        <label htmlFor="wash-time" className="block text-blue-800 text-sm font-bold mb-2">{t.timeFrom}</label>
                        <input type="time" id="wash-time" value={time} onChange={(e) => setTime(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    </div>
                    <button type="submit" className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg">
                        {t.scheduleBooking}
                    </button>
                </form>
            </div>
        </div>
    );
};

const MaintenanceBookingScreen = ({ onBookingComplete, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [carModel, setCarModel] = useState('');
    const [carCompany, setCarCompany] = useState('');
    const [maintenanceType, setMaintenanceType] = useState('');
    const [date, setDate] = useState('');
    const [time, setTime] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (carModel && carCompany && maintenanceType && date && time) {
            showModal(t.bookingScheduled, `${maintenanceType} for ${carCompany} ${carModel} scheduled for ${date} at ${time}.`);
            onBookingComplete({ type: maintenanceType, car: `${carCompany} ${carModel}`, date, time, status: t.confirmed, amount: 500 }); // Mock amount
        } else {
            showModal(t.selectionRequired, t.pleaseFillAllFields);
        }
    };

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.vehicleMaintenance}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="car-company" className="block text-blue-800 text-sm font-bold mb-2">{t.carCompany}</label>
                        <input type="text" id="car-company" value={carCompany} onChange={(e) => setCarCompany(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., Maruti Suzuki" />
                    </div>
                    <div>
                        <label htmlFor="car-model" className="block text-blue-800 text-sm font-bold mb-2">{t.carModel}</label>
                        <input type="text" id="car-model" value={carModel} onChange={(e) => setCarModel(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., Swift Dzire" />
                    </div>
                    <div>
                        <label htmlFor="maintenance-type" className="block text-blue-800 text-sm font-bold mb-2">{t.maintenanceType}</label>
                        <select id="maintenance-type" value={maintenanceType} onChange={(e) => setMaintenanceType(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400">
                            <option value="">{t.selectMaintenance}</option>
                            <option value="Oil Change">{t.oilChange}</option>
                            <option value="Tire Rotation">{t.tireRotation}</option>
                            <option value="Brake Inspection">{t.brakeInspection}</option>
                            <option value="Full Service">{t.fullService}</option>
                            <option value="Other">{t.other}</option>
                        </select>
                    </div>
                    <div>
                        <label htmlFor="maintenance-date" className="block text-blue-800 text-sm font-bold mb-2">{t.date}</label>
                        <input type="date" id="maintenance-date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    </div>
                    <div>
                        <label htmlFor="maintenance-time" className="block text-blue-800 text-sm font-bold mb-2">{t.timeFrom}</label>
                        <input type="time" id="maintenance-time" value={time} onChange={(e) => setTime(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    </div>
                    <button type="submit" className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg">
                        {t.scheduleBooking}
                    </button>
                </form>
            </div>
        </div>
    );
};

const ValetBookingScreen = ({ onBookingComplete, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [pickupLocation, setPickupLocation] = useState('');
    const [dropoffLocation, setDropoffLocation] = useState('');
    const [date, setDate] = useState('');
    const [time, setTime] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (pickupLocation && dropoffLocation && date && time) {
            showModal(t.valetBooked, `Valet service booked from ${pickupLocation} to ${dropoffLocation} on ${date} at ${time}.`);
            onBookingComplete({ type: 'Valet Service', pickup: pickupLocation, dropoff: dropoffLocation, date, time, status: t.confirmed, amount: 250 }); // Mock amount
        } else {
            showModal(t.selectionRequired, t.pleaseFillAllFields);
        }
    };

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.valetBooking}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="pickup-location" className="block text-blue-800 text-sm font-bold mb-2">{t.pickUpLocation}</label>
                        <input type="text" id="pickup-location" value={pickupLocation} onChange={(e) => setPickupLocation(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., Office entrance" />
                    </div>
                    <div>
                        <label htmlFor="dropoff-location" className="block text-blue-800 text-sm font-bold mb-2">{t.dropOffLocation}</label>
                        <input type="text" id="dropoff-location" value={dropoffLocation} onChange={(e) => setDropoffLocation(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="e.g., Home address" />
                    </div>
                    <div>
                        <label htmlFor="valet-date" className="block text-blue-800 text-sm font-bold mb-2">{t.date}</label>
                        <input type="date" id="valet-date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    </div>
                    <div>
                        <label htmlFor="valet-time" className="block text-blue-800 text-sm font-bold mb-2">{t.timeFrom}</label>
                        <input type="time" id="valet-time" value={time} onChange={(e) => setTime(e.target.value)} className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    </div>
                    <button type="submit" className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg">
                        {t.scheduleBooking}
                    </button>
                </form>
            </div>
        </div>
    );
};


// Services Screen (New/Enhanced)
const ServicesScreen = ({ showModal, onNavigate, onAddServiceBooking }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];

    const handleJumpStart = () => {
        showModal(t.gpsRequired, t.enableGpsMessage, 
            <button 
                onClick={() => { 
                    showModal(t.gpsEnabled, "GPS location enabled. Sending request..."); 
                    // Simulate sending jump start request
                    onAddServiceBooking({ type: 'Jump Start', date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), status: t.confirmed, amount: 0 });
                }} 
                className="mt-4 bg-green-600 text-white font-bold py-2 px-5 rounded-xl hover:bg-green-700 transition duration-300"
            >
                {t.enableGps}
            </button>
        );
    };

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            {/* Main Add-on Services */}
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.services}</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-blue-100 rounded-xl shadow-md p-4 flex flex-col items-center text-center">
                        <img 
                            src="https://placehold.co/120x80/6a0dad/ffffff?text=Car+Wash" 
                            alt="Car Wash" 
                            className="rounded-lg mb-3"
                            onError={(e) => {e.target.onerror=null;e.target.src='https://placehold.co/120x80/6a0dad/ffffff?text=Image+Error';}}
                        />
                        <h3 className="text-xl font-bold text-blue-900 mb-1">{t.carWashDetailing}</h3>
                        <p className="text-blue-700 text-sm mb-3">{t.getCarSparkling}</p>
                        <button 
                            onClick={() => onNavigate('carWashBooking')} 
                            className="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300"
                            aria-label={t.scheduleService}
                        >
                            {t.scheduleService}
                        </button>
                    </div>
                    <div className="bg-blue-100 rounded-xl shadow-md p-4 flex flex-col items-center text-center">
                        <img 
                            src="https://placehold.co/120x80/007bff/ffffff?text=EV+Charging" 
                            alt="EV Charging" 
                            className="rounded-lg mb-3"
                            onError={(e) => {e.target.onerror=null;e.target.src='https://placehold.co/120x80/007bff/ffffff?text=Image+Error';}}
                        />
                        <h3 className="text-xl font-bold text-blue-900 mb-1">{t.evCharging}</h3>
                        <p className="text-blue-700 text-sm mb-3">{t.findBookCharging}</p>
                        <button 
                            onClick={() => onNavigate('home')} // Navigate to home map
                            className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300"
                            aria-label={t.locateCharging}
                        >
                            {t.locateCharging}
                        </button>
                    </div>
                    <div className="bg-blue-100 rounded-xl shadow-md p-4 flex flex-col items-center text-center">
                        <img 
                            src="https://placehold.co/120x80/dc3545/ffffff?text=Maintenance" 
                            alt="Vehicle Maintenance" 
                            className="rounded-lg mb-3"
                            onError={(e) => {e.target.onerror=null;e.target.src='https://placehold.co/120x80/dc3545/ffffff?text=Image+Error';}}
                        />
                        <h3 className="text-xl font-bold text-blue-900 mb-1">{t.vehicleMaintenance}</h3>
                        <p className="text-blue-700 text-sm mb-3">{t.minorServicing}</p>
                        <button 
                            onClick={() => onNavigate('maintenanceBooking')} 
                            className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300"
                            aria-label={t.scheduleService}
                        >
                            {t.scheduleService}
                        </button>
                    </div>
                    <div className="bg-blue-100 rounded-xl shadow-md p-4 flex flex-col items-center text-center">
                        <img 
                            src="https://placehold.co/120x80/ffc107/000000?text=Valet+Parking" 
                            alt="Valet Parking" 
                            className="rounded-lg mb-3"
                            onError={(e) => {e.target.onerror=null;e.target.src='https://placehold.co/120x80/ffc107/000000?text=Image+Error';}}
                        />
                        <h3 className="text-xl font-bold text-blue-900 mb-1">{t.valetParking}</h3>
                        <p className="text-blue-700 text-sm mb-3">{t.hassleFreeParking}</p>
                        <button 
                            onClick={() => onNavigate('valetBooking')} 
                            className="bg-amber-600 text-blue-900 font-bold py-2 px-4 rounded-lg hover:bg-amber-700 transition duration-300"
                            aria-label={t.bookValetService}
                        >
                            {t.bookValetService}
                        </button>
                    </div>
                </div>
            </div>

            {/* Additional Options/Features */}
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-blue-900 mb-4">Additional SmartPark Features</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div 
                        className="bg-blue-100 rounded-xl shadow-md p-4 cursor-pointer hover:bg-blue-200 transition duration-300"
                        onClick={() => showModal(t.priorityBooking, t.premiumBenefits)}
                    >
                        <h3 className="text-xl font-bold text-amber-600 mb-2">{t.priorityBooking}</h3>
                        <p className="text-blue-700 text-sm">{t.premiumBenefits}</p>
                    </div>
                    <div 
                        className="bg-blue-100 rounded-xl shadow-md p-4 cursor-pointer hover:bg-blue-200 transition duration-300"
                        onClick={() => showModal(t.dynamicPricing, t.pricingAdjusts)}
                    >
                        <h3 className="text-xl font-bold text-amber-600 mb-2">{t.dynamicPricing}</h3>
                        <p className="text-blue-700 text-sm">{t.pricingAdjusts}</p>
                    </div>
                    <div 
                        className="bg-blue-100 rounded-xl shadow-md p-4 cursor-pointer hover:bg-blue-200 transition duration-300"
                        onClick={() => showModal(t.corporateBilling, t.streamlineExpenses)}
                    >
                        <h3 className="text-xl font-bold text-amber-600 mb-2">{t.corporateBillingBenefits}</h3>
                        <p className="text-blue-700 text-sm">{t.streamlineExpenses}</p>
                    </div>
                    <div className="bg-blue-100 rounded-xl shadow-md p-4">
                        <h3 className="text-xl font-bold text-amber-600 mb-2">{t.emergencyServices}</h3>
                        <p className="text-blue-700 text-sm mb-3">{t.requestAssistance}</p>
                        <button 
                            onClick={handleJumpStart} 
                            className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300"
                            aria-label={t.requestJumpStart}
                        >
                            {t.requestJumpStart}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- About Us Screen ---
const AboutUsScreen = () => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.aboutUs}</h2>
                <p className="text-blue-800 mb-4">{t.aboutUsContent}</p>
                <p className="text-blue-600 text-sm italic">{t.disclaimer}</p>
            </div>
        </div>
    );
};


// Settings Screen
const SettingsScreen = ({ showModal, setAppLanguage, onLogout, onNavigate }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];

    const handleDeleteAccount = () => {
        showModal(t.confirmDeletion, null,
            <div>
                <p>{t.areYouSureDeleteAccount}</p>
                <p className="text-sm text-red-400 mt-2">{t.gdprDataRemoval}</p>
                <button 
                    onClick={() => { 
                        showModal(t.accountDeleted, t.accountDeletedMessage); 
                        onLogout(); // Log out after account deletion
                    }} 
                    className="mt-4 bg-red-600 text-white font-bold py-2 px-5 rounded-xl hover:bg-red-700 transition duration-300"
                    aria-label={t.confirmDeletion}
                >
                    {t.deleteMyAccount}
                </button>
            </div>
        );
    };

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.appSettings}</h2>

                <div className="mb-6">
                    <h3 className="text-xl font-semibold text-blue-900 mb-3">{t.languageRegion}</h3>
                    <select 
                        value={appLanguage} 
                        onChange={(e) => setAppLanguage(e.target.value)} 
                        className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        aria-label={t.languageRegion}
                    >
                        <option value="en">English</option>
                        <option value="hi">हिंदी (Hindi)</option>
                    </select>
                    <p className="text-blue-700 text-sm mt-2">{t.currentLanguage(appLanguage === 'en' ? 'English' : 'Hindi')}</p>
                </div>

                <div className="mb-6">
                    <h3 className="text-xl font-semibold text-blue-900 mb-3">{t.familySharing}</h3>
                    <p className="text-blue-700 mb-2">{t.shareSubscription}</p>
                    <button 
                        onClick={() => showModal(t.familySharing, t.familySharingInitiated)} 
                        className="bg-purple-600 text-white font-bold py-2 px-5 rounded-xl hover:bg-purple-700 transition duration-300"
                        aria-label={t.manageFamily}
                    >
                        {t.manageFamily}
                    </button>
                </div>
                
                <div className="mb-6">
                    <h3 className="text-xl font-semibold text-blue-900 mb-3">{t.dataPrivacy}</h3>
                    <button 
                        onClick={handleDeleteAccount} 
                        className="bg-red-700 text-white font-bold py-2 px-5 rounded-xl hover:bg-red-800 transition duration-300"
                        aria-label={t.deleteMyAccount}
                    >
                        {t.deleteMyAccount}
                    </button>
                    <p className="text-blue-700 text-sm mt-2">{t.exerciseRightToDelete}</p>
                </div>

                <div>
                    <h3 className="text-xl font-semibold text-blue-900 mb-3">{t.aboutUs}</h3>
                    <button 
                        onClick={() => onNavigate('aboutUs')} 
                        className="bg-blue-600 text-white font-bold py-2 px-5 rounded-xl hover:bg-blue-700 transition duration-300"
                        aria-label={t.aboutUs}
                    >
                        {t.aboutUs}
                    </button>
                </div>
            </div>
        </div>
    );
};

const PrebookScreen = ({ showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    return (
        <div className="p-4 space-y-6 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-lg border border-blue-200">
                <h3 className="text-xl font-bold text-amber-600 mb-4">{t.prebookAdvanced}</h3>
                <div className="space-y-4">
                    <div>
                        <label htmlFor="prebook-location" className="block text-blue-800 text-sm font-bold mb-2">{t.location}</label>
                        <input 
                            type="text" 
                            id="prebook-location" 
                            placeholder="e.g., Near Railway Station" 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        />
                    </div>
                    <div>
                        <label htmlFor="prebook-date" className="block text-blue-800 text-sm font-bold mb-2">{t.date}</label>
                        <input 
                            type="date" 
                            id="prebook-date" 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        />
                    </div>
                    <div>
                        <label htmlFor="prebook-time-from" className="block text-blue-800 text-sm font-bold mb-2">{t.timeFrom}</label>
                        <input 
                            type="time" 
                            id="prebook-time-from" 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        />
                    </div>
                    <div>
                        <label htmlFor="prebook-time-to" className="block text-blue-800 text-sm font-bold mb-2">{t.timeTo}</label>
                        <input 
                            type="time" 
                            id="prebook-time-to" 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        />
                    </div>
                </div>
                <button 
                    onClick={() => showModal(t.prebook, t.prebookSubmitted)} 
                    className="mt-6 w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg"
                >
                    {t.confirmPrebook}
                </button>
            </div>
        </div>
    );
};

const MyBookingsScreen = ({ bookings, onRepeatBooking }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    return (
        <div className="p-4 space-y-6 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-lg border border-blue-200">
                <h3 className="text-xl font-bold text-amber-600 mb-4">{t.myBookings}</h3>
                <div className="space-y-3">
                    {bookings.length === 0 ? (
                        <p className="text-blue-700 text-center">{t.noBookingsYet}</p>
                    ) : (
                        bookings.map((booking, index) => (
                            <div key={index} className="bg-blue-100 p-3 rounded-xl shadow-md">
                                <p className="font-bold text-blue-900">{booking.slotName || booking.type}</p>
                                {booking.car && <p className="text-sm text-blue-700">{booking.car}</p>}
                                {booking.pickup && <p className="text-sm text-blue-700">From: {booking.pickup}</p>}
                                {booking.dropoff && <p className="text-sm text-blue-700">To: {booking.dropoff}</p>}
                                <p className="text-sm text-blue-700">{booking.date} | {booking.time}</p>
                                <p className="text-sm text-pink-600 mt-1">{t.status} {booking.status}</p>
                                {booking.carWash && <p className="text-sm text-blue-700">Includes Car Wash</p>}
                                {booking.amount > 0 && <p className="text-sm text-blue-900 font-semibold">Total: ₹{booking.amount.toFixed(2)}</p>}
                                
                                {booking.status === t.confirmed && booking.slotName && (
                                    <button 
                                        onClick={() => onRepeatBooking(booking)}
                                        className="mt-2 bg-purple-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-300"
                                    >
                                        {t.repeatBooking}
                                    </button>
                                )}
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>
    );
};


// --- Customer App Main Component ---
const CustomerApp = ({ onLogout, onBackToUserTypeSelection }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];

    const [currentScreen, setCurrentScreen] = useState('login'); // Start with login
    const [loggedIn, setLoggedIn] = useState(false);
    const [bookingDetails, setBookingDetails] = useState(null);
    const [paymentAmount, setPaymentAmount] = useState(0);
    const [customerBookings, setCustomerBookings] = useState([]); // New state for bookings

    const [showModal, setShowModal] = useState(false);
    const [modalTitle, setModalTitle] = useState('');
    const [modalMessage, setModalMessage] = useState('');
    const [modalChildren, setModalChildren] = useState(null);

    const openModal = (title, message, children = null) => {
        setModalTitle(title);
        setModalMessage(message);
        setModalChildren(children);
        setShowModal(true);
    };

    const closeModal = () => {
        setShowModal(false);
        setModalTitle('');
        setModalMessage('');
        setModalChildren(null);
    };

    const handleLoginSuccess = () => {
        setLoggedIn(true);
        setCurrentScreen('home');
    };

    const handleRegisterSuccess = () => {
        setLoggedIn(true);
        setCurrentScreen('home');
    };

    const handleSearchSuccess = () => {
        setCurrentScreen('slotSelection');
    };

    const handleSlotSelect = (slot, carWash) => {
        setBookingDetails({ slot, carWash });
        setCurrentScreen('bookingSummary');
    };

    const handleConfirmBooking = (amount) => {
        setPaymentAmount(amount);
        setCurrentScreen('payment');
    };

    const handlePaymentSuccess = () => {
        // Add parking booking to history
        const newBooking = {
            id: generateId(),
            slotName: bookingDetails.slot.name,
            date: new Date().toLocaleDateString(),
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            amount: paymentAmount,
            status: t.confirmed,
            carWash: bookingDetails.carWash,
            originalSlot: bookingDetails.slot // Store original slot for repeat booking
        };
        setCustomerBookings(prev => [...prev, newBooking]);
        setCurrentScreen('invoicing');
    };

    const handleNewBooking = () => {
        setBookingDetails(null);
        setPaymentAmount(0);
        setCurrentScreen('home');
    };

    const handleRepeatBooking = (booking) => {
        // Simulate re-selecting the slot and going to booking summary
        setBookingDetails({ slot: booking.originalSlot, carWash: booking.carWash });
        setCurrentScreen('bookingSummary');
        openModal(t.repeatBooking, `Repeating booking for ${booking.slotName}.`);
    };

    const handleAddServiceBooking = (serviceBooking) => {
        setCustomerBookings(prev => [...prev, { ...serviceBooking, id: generateId(), status: t.confirmed }]);
        navigateTo('mybookings'); // Go to my bookings to show the new service booking
    };

    const navigateTo = (screen) => {
        setCurrentScreen(screen);
    };

    return (
        <div className="min-h-screen bg-white text-blue-900 flex flex-col">
            <Header onNavigate={navigateTo} onLogout={onLogout} showLogout={loggedIn} />

            <main className="flex-1 overflow-y-auto"> {/* Added overflow-y-auto */}
                {!loggedIn ? (
                    currentScreen === 'login' ? (
                        <CustomerLoginScreen 
                            onLoginSuccess={handleLoginSuccess} 
                            onRegisterClick={() => setCurrentScreen('registration')} 
                            onForgotPasswordClick={() => setCurrentScreen('forgotPassword')}
                            onBackToUserTypeSelection={onBackToUserTypeSelection}
                            showModal={openModal}
                        />
                    ) : currentScreen === 'registration' ? (
                        <RegistrationScreen 
                            onRegisterSuccess={handleRegisterSuccess} 
                            onLoginClick={() => setCurrentScreen('login')}
                            onBackToUserTypeSelection={onBackToUserTypeSelection}
                            showModal={openModal}
                        />
                    ) : ( // forgotPassword screen
                        <ForgotPasswordScreen 
                            onBackToLogin={() => setCurrentScreen('login')}
                            showModal={openModal}
                        />
                    )
                ) : (
                    <div key={appLanguage} className="flex-1"> {/* Added key for language change */}
                        {currentScreen === 'home' && (
                            <HomeScreen onSearchSuccess={handleSearchSuccess} showModal={openModal} />
                        )}
                        {currentScreen === 'slotSelection' && (
                            <SlotSelectionScreen onSlotSelect={handleSlotSelect} showModal={openModal} />
                        )}
                        {currentScreen === 'bookingSummary' && (
                            <BookingSummaryScreen bookingDetails={bookingDetails} onConfirmBooking={handleConfirmBooking} showModal={openModal} />
                        )}
                        {currentScreen === 'payment' && (
                            <PaymentScreen amount={paymentAmount} onPaymentSuccess={handlePaymentSuccess} showModal={openModal} />
                        )}
                        {currentScreen === 'invoicing' && (
                            <InvoicingScreen bookingDetails={bookingDetails} amount={paymentAmount} onNewBooking={handleNewBooking} showModal={openModal} />
                        )}
                        {currentScreen === 'settings' && (
                            <SettingsScreen showModal={openModal} onLogout={onLogout} onNavigate={navigateTo} />
                        )}
                        {currentScreen === 'services' && (
                            <ServicesScreen showModal={openModal} onNavigate={navigateTo} onAddServiceBooking={handleAddServiceBooking} />
                        )}
                        {currentScreen === 'prebook' && (
                            <PrebookScreen showModal={openModal} />
                        )}
                        {currentScreen === 'mybookings' && (
                            <MyBookingsScreen bookings={customerBookings} onRepeatBooking={handleRepeatBooking} />
                        )}
                        {currentScreen === 'carWashBooking' && (
                            <CarWashBookingScreen onBookingComplete={handleAddServiceBooking} showModal={openModal} />
                        )}
                        {currentScreen === 'maintenanceBooking' && (
                            <MaintenanceBookingScreen onBookingComplete={handleAddServiceBooking} showModal={openModal} />
                        )}
                        {currentScreen === 'valetBooking' && (
                            <ValetBookingScreen onBookingComplete={handleAddServiceBooking} showModal={openModal} />
                        )}
                        {currentScreen === 'aboutUs' && (
                            <AboutUsScreen />
                        )}
                    </div>
                )}
            </main>

            {loggedIn && ( 
                <nav className="fixed bottom-0 left-0 right-0 bg-blue-800 border-t border-blue-700 shadow-lg z-20">
                    <ul className="flex justify-around items-center h-16">
                        <li>
                            <button 
                                onClick={() => navigateTo('home')} 
                                className={`flex flex-col items-center text-sm font-semibold p-2 rounded-xl transition duration-300 ${currentScreen === 'home' ? 'text-amber-400' : 'text-blue-200 hover:text-white'}`}
                            >
                                <span className="text-xl">🏠</span>
                                {t.home}
                            </button>
                        </li>
                        <li>
                            <button 
                                onClick={() => navigateTo('prebook')} 
                                className={`flex flex-col items-center text-sm font-semibold p-2 rounded-xl transition duration-300 ${currentScreen === 'prebook' ? 'text-amber-400' : 'text-blue-200 hover:text-white'}`}
                            >
                                <span className="text-xl">🗓️</span>
                                {t.prebook}
                            </button>
                        </li>
                        <li>
                            <button 
                                onClick={() => navigateTo('services')} 
                                className={`flex flex-col items-center text-sm font-semibold p-2 rounded-xl transition duration-300 ${currentScreen === 'services' ? 'text-amber-400' : 'text-blue-200 hover:text-white'}`}
                            >
                                <span className="text-xl">✨</span>
                                {t.services}
                            </button>
                        </li>
                        <li>
                            <button 
                                onClick={() => navigateTo('mybookings')} 
                                className={`flex flex-col items-center text-sm font-semibold p-2 rounded-xl transition duration-300 ${currentScreen === 'mybookings' ? 'text-amber-400' : 'text-blue-200 hover:text-white'}`}
                            >
                                <span className="text-xl">📝</span>
                                {t.bookings}
                            </button>
                        </li>
                    </ul>
                </nav>
            )}

            <Modal show={showModal} title={modalTitle} message={modalMessage} onClose={closeModal}>
                {modalChildren}
            </Modal>
        </div>
    );
};

// --- Service Provider App Screens ---

// Provider Login Screen
const ProviderLoginScreen = ({ onLoginSuccess, onRegisterClick, onForgotPasswordClick, onBackToUserTypeSelection, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        // Simple mock authentication
        if (username === 'provider' && password === 'password') {
            showModal(t.welcomeProvider, t.welcomeProvider);
            onLoginSuccess();
        } else {
            showModal(t.loginFailed, t.invalidCredentials);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-[calc(100vh-160px)] p-4 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-8 shadow-xl max-w-md w-full border border-blue-200">
                <h2 className="text-3xl font-bold text-amber-600 mb-6 text-center">{t.providerLogin}</h2>
                <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                        <label htmlFor="provider-username" className="block text-blue-800 text-sm font-bold mb-2">{t.username}</label>
                        <input 
                            type="text" 
                            id="provider-username" 
                            value={username} 
                            onChange={(e) => setUsername(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="provider"
                            aria-label={t.username}
                        />
                    </div>
                    <div>
                        <label htmlFor="provider-password" className="block text-blue-800 text-sm font-bold mb-2">{t.password}</label>
                        <input 
                            type="password" 
                            id="provider-password" 
                            value={password} 
                            onChange={(e) => setPassword(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="password"
                            aria-label={t.password}
                        />
                    </div>
                    <button 
                        type="submit" 
                        className="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg"
                        aria-label={t.login}
                    >
                        {t.login}
                    </button>
                </form>
                <button 
                    onClick={onForgotPasswordClick} 
                    className="mt-4 w-full text-blue-800 text-sm font-bold hover:underline"
                    aria-label={t.forgotPassword}
                >
                    {t.forgotPassword}
                </button>
                <button 
                    onClick={onRegisterClick} 
                    className="mt-2 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.providerRegistration}
                >
                    {t.providerRegistration}
                </button>
                <button 
                    onClick={onBackToUserTypeSelection} 
                    className="mt-4 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.backToUserTypeSelection}
                >
                    {t.backToUserTypeSelection}
                </button>
            </div>
        </div>
    );
};

// Provider Registration Screen
const ProviderRegistrationScreen = ({ onRegisterSuccess, onLoginClick, onBackToUserTypeSelection, showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [name, setName] = useState('');
    const [mobile, setMobile] = useState('');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleRegister = (e) => {
        e.preventDefault();
        if (name && mobile && email && password) {
            showModal(t.registrationSuccessful, t.welcomeProvider);
            console.log(t.emailSent + email); // Simulate sending email
            onRegisterSuccess();
        } else {
            showModal(t.registrationFailed, t.pleaseFillAllFields);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-[calc(100vh-160px)] p-4 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-8 shadow-xl max-w-md w-full border border-blue-200">
                <h2 className="text-3xl font-bold text-amber-600 mb-6 text-center">{t.registerAsProvider}</h2>
                <form onSubmit={handleRegister} className="space-y-4">
                    <div>
                        <label htmlFor="provider-reg-name" className="block text-blue-800 text-sm font-bold mb-2">{t.fullName}</label>
                        <input 
                            type="text" 
                            id="provider-reg-name" 
                            value={name} 
                            onChange={(e) => setName(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="Service Provider Name"
                            aria-label={t.fullName}
                        />
                    </div>
                    <div>
                        <label htmlFor="provider-reg-mobile" className="block text-blue-800 text-sm font-bold mb-2">{t.mobileNumber}</label>
                        <input 
                            type="tel" 
                            id="provider-reg-mobile" 
                            value={mobile} 
                            onChange={(e) => setMobile(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="9876543210"
                            aria-label={t.mobileNumber}
                        />
                    </div>
                    <div>
                        <label htmlFor="provider-reg-email" className="block text-blue-800 text-sm font-bold mb-2">{t.email}</label>
                        <input 
                            type="email" 
                            id="provider-reg-email" 
                            value={email} 
                            onChange={(e) => setEmail(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="provider@example.com"
                            aria-label={t.email}
                        />
                    </div>
                    <div>
                        <label htmlFor="provider-reg-password" className="block text-blue-800 text-sm font-bold mb-2">{t.password}</label>
                        <input 
                            type="password" 
                            id="provider-reg-password" 
                            value={password} 
                            onChange={(e) => setPassword(e.target.value)} 
                            className="w-full p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400" 
                            placeholder="********"
                            aria-label={t.password}
                        />
                    </div>
                    <button 
                        type="submit" 
                        className="w-full bg-pink-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg"
                        aria-label={t.register}
                    >
                        {t.register}
                    </button>
                </form>
                <button 
                    onClick={onLoginClick} 
                    className="mt-4 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.providerLogin}
                >
                    {t.providerLogin}
                </button>
                <button 
                    onClick={onBackToUserTypeSelection} 
                    className="mt-4 w-full text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-100 transition duration-300"
                    aria-label={t.backToUserTypeSelection}
                >
                    {t.backToUserTypeSelection}
                </button>
            </div>
        </div>
    );
};


// Provider Dashboard Screen
const ProviderDashboardScreen = ({ showModal }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    const [parkingSpots, setParkingSpots] = useState([
        { id: 'A1', type: 'standard', available: true },
        { id: 'A2', type: 'premium', available: true },
        { id: 'B1', type: 'ev', available: false },
    ]);
    const [newSpotId, setNewSpotId] = useState('');
    const [newSpotType, setNewSpotType] = useState('standard');
    const [serviceRequests, setServiceRequests] = useState([
        { id: generateId(), type: 'Car Wash', customer: 'John Doe', status: 'Pending' },
        { id: generateId(), type: 'Jump-Start', customer: 'Jane Smith', status: 'Pending' },
    ]);

    const handleAddSpot = () => {
        if (newSpotId && !parkingSpots.some(spot => spot.id === newSpotId)) {
            setParkingSpots([...parkingSpots, { id: newSpotId, type: newSpotType, available: true }]);
            showModal(t.spotAdded(newSpotId), '');
            setNewSpotId('');
        } else if (parkingSpots.some(spot => spot.id === newSpotId)) {
            showModal(t.spotAlreadyExists(newSpotId), '');
        }
    };

    const handleRemoveSpot = (id) => {
        if (parkingSpots.some(spot => spot.id === id)) {
            setParkingSpots(parkingSpots.filter(spot => spot.id !== id));
            showModal(t.spotRemoved(id), '');
        } else {
            showModal(t.spotNotFound(id), '');
        }
    };

    const handleCompleteRequest = (id) => {
        setServiceRequests(serviceRequests.map(req => 
            req.id === id ? { ...req, status: 'Completed' } : req
        ));
        showModal(t.requestCompleted, '');
    };

    const occupiedSpots = parkingSpots.filter(spot => !spot.available).length;
    const availableSpots = parkingSpots.filter(spot => spot.available).length;

    return (
        <div className="p-8 space-y-8 bg-white text-blue-900">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-amber-600 mb-4">{t.dashboard}</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div className="bg-blue-100 p-4 rounded-xl shadow-md">
                        <p className="text-blue-700">{t.parkingSpots}</p>
                        <p className="text-3xl font-bold text-blue-900">{parkingSpots.length}</p>
                    </div>
                    <div className="bg-blue-100 p-4 rounded-xl shadow-md">
                        <p className="text-blue-700">{t.occupiedSpots}</p>
                        <p className="text-3xl font-bold text-red-600">{occupiedSpots}</p>
                    </div>
                    <div className="bg-blue-100 p-4 rounded-xl shadow-md">
                        <p className="text-blue-700">{t.availableSpots}</p>
                        <p className="text-3xl font-bold text-green-600">{availableSpots}</p>
                    </div>
                </div>
            </div>

            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-blue-900 mb-4">{t.manageSpots}</h2>
                <div className="flex flex-col md:flex-row gap-4 mb-4">
                    <input 
                        type="text" 
                        placeholder={t.spotId} 
                        value={newSpotId} 
                        onChange={(e) => setNewSpotId(e.target.value)} 
                        className="flex-grow p-3 rounded-xl bg-blue-100 text-blue-900 placeholder-blue-400 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        aria-label={t.spotId}
                    />
                    <select
                        value={newSpotType}
                        onChange={(e) => setNewSpotType(e.target.value)}
                        className="p-3 rounded-xl bg-blue-100 text-blue-900 focus:outline-none focus:ring-2 focus:ring-amber-400"
                        aria-label={t.spotType}
                    >
                        <option value="standard">{t.standard}</option>
                        <option value="premium">{t.premiumSpot}</option>
                        <option value="ev">{t.evChargingSpot}</option>
                        <option value="valet">{t.valetSpot}</option>
                    </select>
                    <button 
                        onClick={handleAddSpot} 
                        className="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 shadow-lg"
                        aria-label={t.add}
                    >
                        {t.add}
                    </button>
                </div>
                <div className="space-y-2">
                    {parkingSpots.map(spot => (
                        <div key={spot.id} className="flex justify-between items-center bg-blue-100 p-3 rounded-xl shadow-md">
                            <p className="font-bold text-blue-900">{spot.id} ({spot.type}) - {spot.available ? t.available : t.occupied}</p>
                            <button 
                                onClick={() => handleRemoveSpot(spot.id)} 
                                className="bg-red-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300"
                                aria-label={t.remove}
                            >
                                {t.remove}
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="bg-blue-50 rounded-2xl p-6 shadow-xl border border-blue-200">
                <h2 className="text-2xl font-bold text-blue-900 mb-4">{t.manageServiceRequests}</h2>
                <div className="space-y-3">
                    {serviceRequests.length === 0 ? (
                        <p className="text-blue-700 text-center">{t.noServiceRequests}</p>
                    ) : (
                        serviceRequests.map(request => (
                            <div key={request.id} className="flex justify-between items-center bg-blue-100 p-3 rounded-xl shadow-md">
                                <div>
                                    <p className="font-bold text-blue-900">{request.type} ({request.customer})</p>
                                    <p className="text-sm text-blue-700">{t.status}: {request.status}</p>
                                </div>
                                {request.status === 'Pending' && (
                                    <button 
                                        onClick={() => handleCompleteRequest(request.id)} 
                                        className="bg-green-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300"
                                        aria-label={t.complete}
                                    >
                                        {t.complete}
                                    </button>
                                )}
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>
    );
};

// --- Service Provider App Main Component ---
const ServiceProviderApp = ({ onLogout, onBackToUserTypeSelection }) => {
    const [currentScreen, setCurrentScreen] = useState('login'); // Start with login
    const [loggedIn, setLoggedIn] = useState(false);
    const [showModal, setShowModal] = useState(false);
    const [modalTitle, setModalTitle] = useState('');
    const [modalMessage, setModalMessage] = useState('');
    const [modalChildren, setModalChildren] = useState(null);

    const openModal = (title, message, children = null) => {
        setModalTitle(title);
        setModalMessage(message);
        setModalChildren(children);
        setShowModal(true);
    };

    const closeModal = () => {
        setShowModal(false);
        setModalTitle('');
        setModalMessage('');
        setModalChildren(null);
    };

    const handleLoginSuccess = () => {
        setLoggedIn(true);
        setCurrentScreen('dashboard');
    };

    const handleRegisterSuccess = () => {
        setLoggedIn(true);
        setCurrentScreen('dashboard');
    };

    return (
        <div className="min-h-screen bg-white text-blue-900 flex flex-col">
            <Header onNavigate={() => {}} onLogout={onLogout} showLogout={loggedIn} />
            <main className="flex-1 overflow-y-auto"> {/* Added overflow-y-auto */}
                {!loggedIn ? (
                    currentScreen === 'login' ? (
                        <ProviderLoginScreen 
                            onLoginSuccess={handleLoginSuccess} 
                            onRegisterClick={() => setCurrentScreen('registration')} 
                            onForgotPasswordClick={() => setCurrentScreen('forgotPassword')}
                            onBackToUserTypeSelection={onBackToUserTypeSelection}
                            showModal={openModal}
                        />
                    ) : currentScreen === 'registration' ? (
                        <ProviderRegistrationScreen 
                            onRegisterSuccess={handleRegisterSuccess} 
                            onLoginClick={() => setCurrentScreen('login')}
                            onBackToUserTypeSelection={onBackToUserTypeSelection}
                            showModal={openModal}
                        />
                    ) : ( // forgotPassword screen
                        <ForgotPasswordScreen 
                            onBackToLogin={() => setCurrentScreen('login')}
                            showModal={openModal}
                        />
                    )
                ) : (
                    <div key={appLanguage} className="flex-1"> {/* Added key for language change */}
                        <ProviderDashboardScreen showModal={openModal} />
                    </div>
                )}
            </main>
            <Modal show={showModal} title={modalTitle} message={modalMessage} onClose={closeModal}>
                {modalChildren}
            </Modal>
        </div>
    );
};

// --- User Type Selection Screen ---
const UserTypeSelectionScreen = ({ setUserType }) => {
    const { appLanguage } = useContext(LanguageContext);
    const t = translations[appLanguage];
    return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-white text-blue-900 p-4">
            <div className="bg-blue-100 rounded-2xl p-8 shadow-xl max-w-md w-full text-center border border-blue-300">
                <h2 className="text-3xl font-bold text-amber-600 mb-6">{t.selectUserType}</h2>
                <div className="mb-6 rounded-xl overflow-hidden shadow-lg flex justify-center items-center h-48 bg-blue-200"> {/* Adjusted for logo */}
                    {/* Replaced video with logo placeholder */}
                    <img 
                        src="https://placehold.co/150x150/00008B/FFFFFF?text=SmartPark+Logo" 
                        alt="SmartPark Logo" 
                        className="w-36 h-36 object-contain"
                        onError={(e) => {e.target.onerror=null;e.target.src='https://placehold.co/150x150/00008B/FFFFFF?text=Logo+Error';}}
                    />
                </div>
                <div className="space-y-4">
                    <button 
                        onClick={() => setUserType('customer')} 
                        className="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg"
                    >
                        {t.customerApp}
                    </button>
                    <button 
                        onClick={() => setUserType('provider')} 
                        className="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-purple-700 transition duration-300 shadow-lg"
                    >
                        {t.serviceProviderApp}
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- Main App Component ---
function App() {
    const [userType, setUserType] = useState(null); // 'customer', 'provider', or null
    const [appLanguage, setAppLanguage] = useState('en'); // Default language

    const handleLogout = () => {
        setUserType(null); // Go back to user type selection
    };

    return (
        <LanguageContext.Provider value={{ appLanguage, setAppLanguage }}>
            {userType === 'customer' && <CustomerApp key={appLanguage} onLogout={handleLogout} onBackToUserTypeSelection={handleLogout} />}
            {userType === 'provider' && <ServiceProviderApp key={appLanguage} onLogout={handleLogout} onBackToUserTypeSelection={handleLogout} />}
            {userType === null && <UserTypeSelectionScreen setUserType={setUserType} />}
        </LanguageContext.Provider>
    );
}

export default App;
